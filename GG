import logging
import asyncio
from datetime import datetime, time, date, timedelta
from typing import Dict, List, Optional, Tuple
from contextlib import asynccontextmanager

from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    ReplyKeyboardMarkup,
    KeyboardButton,
    ReplyKeyboardRemove
)
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler,
    JobQueue,
)

from database import db, User, Department, Doctor, Appointment, DoctorSchedule
from config import config

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
(
    SELECT_DEPARTMENT,
    SELECT_DOCTOR,
    SELECT_DATE,
    SELECT_TIME,
    ENTER_NAME,
    ENTER_PHONE,
    ENTER_BIRTHDATE,
    ENTER_SYMPTOMS,
    CONFIRM
) = range(9)


class HospitalBot:
    def __init__(self):
        self.app = None

    async def ensure_user(self, telegram_id: int, username: str = None,
                          first_name: str = None, last_name: str = None) -> User:
        """–°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î"""
        async with db.get_session() as session:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            result = await session.execute(
                select(User).where(User.telegram_id == telegram_id)
            )
            user = result.scalar_one_or_none()

            if not user:
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user = User(
                    telegram_id=telegram_id,
                    username=username,
                    first_name=first_name,
                    last_name=last_name
                )
                session.add(user)
                await session.flush()

            return user

    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        user = update.effective_user

        # –°–æ–∑–¥–∞–µ–º/–ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
        await self.ensure_user(
            telegram_id=user.id,
            username=user.username,
            first_name=user.first_name,
            last_name=user.last_name
        )

        welcome_text = f"""
üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user.first_name}!

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏ –∫ –≤—Ä–∞—á—É!

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã
/record - –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º
/my_records - –ú–æ–∏ –∑–∞–ø–∏—Å–∏
/cancel - –û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è

–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:
/admin - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        """

        keyboard = [
            [KeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º")],
            [KeyboardButton("üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏")],
            [KeyboardButton("üè• –û—Ç–¥–µ–ª–µ–Ω–∏—è")],
            [KeyboardButton("üë®‚Äç‚öïÔ∏è –ù–∞—à–∏ –≤—Ä–∞—á–∏")]
        ]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

        await update.message.reply_text(welcome_text, reply_markup=reply_markup)
        return ConversationHandler.END

    async def start_record(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–ø–∏—Å–∏"""
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        context.user_data.clear()

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–¥–µ–ª–µ–Ω–∏—è –∏–∑ –ë–î
        async with db.get_session() as session:
            result = await session.execute(
                select(Department).where(Department.is_active == True)
            )
            departments = result.scalars().all()

        if not departments:
            await update.message.reply_text(
                "–í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ—Ç–¥–µ–ª–µ–Ω–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
            return ConversationHandler.END

        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Ç–¥–µ–ª–µ–Ω–∏—è–º–∏
        keyboard = []
        for dept in departments:
            keyboard.append([
                InlineKeyboardButton(
                    f"üè• {dept.name}",
                    callback_data=f"dept_{dept.id}"
                )
            ])

        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            "üè• –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ:",
            reply_markup=reply_markup
        )

        return SELECT_DEPARTMENT

    async def select_department(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–í—ã–±–æ—Ä –æ—Ç–¥–µ–ª–µ–Ω–∏—è"""
        query = update.callback_query
        await query.answer()

        department_id = int(query.data.split("_")[1])
        context.user_data["department_id"] = department_id

        # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–∞—á–µ–π –æ—Ç–¥–µ–ª–µ–Ω–∏—è
        async with db.get_session() as session:
            result = await session.execute(
                select(Doctor)
                .where(Doctor.department_id == department_id)
                .where(Doctor.is_active == True)
            )
            doctors = result.scalars().all()

        if not doctors:
            await query.edit_message_text(
                "–í —ç—Ç–æ–º –æ—Ç–¥–µ–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤—Ä–∞—á–µ–π. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ."
            )
            return SELECT_DEPARTMENT

        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤—Ä–∞—á–∞–º–∏
        keyboard = []
        for doctor in doctors:
            # –°–æ–∫—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            button_text = f"üë®‚Äç‚öïÔ∏è {doctor.full_name}"
            if len(button_text) > 64:  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ callback_data
                button_text = button_text[:61] + "..."

            keyboard.append([
                InlineKeyboardButton(
                    button_text,
                    callback_data=f"doc_{doctor.id}"
                )
            ])

        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_dept")])
        reply_markup = InlineKeyboardMarkup(keyboard)

        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–µ–Ω–∏—è
        async with db.get_session() as session:
            result = await session.execute(
                select(Department).where(Department.id == department_id)
            )
            department = result.scalar_one()

        await query.edit_message_text(
            f"üè• –û—Ç–¥–µ–ª–µ–Ω–∏–µ: {department.name}\n\n"
            "üë®‚Äç‚öïÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞:",
            reply_markup=reply_markup
        )

        return SELECT_DOCTOR

    async def select_doctor(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–í—ã–±–æ—Ä –≤—Ä–∞—á–∞"""
        query = update.callback_query
        await query.answer()

        if query.data == "back_to_dept":
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–µ–Ω–∏—è
            async with db.get_session() as session:
                result = await session.execute(
                    select(Department).where(Department.is_active == True)
                )
                departments = result.scalars().all()

            keyboard = []
            for dept in departments:
                keyboard.append([
                    InlineKeyboardButton(
                        f"üè• {dept.name}",
                        callback_data=f"dept_{dept.id}"
                    )
                ])

            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.edit_message_text(
                "üè• –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ:",
                reply_markup=reply_markup
            )
            return SELECT_DEPARTMENT

        doctor_id = int(query.data.split("_")[1])
        context.user_data["doctor_id"] = doctor_id

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–∞—á–µ
        async with db.get_session() as session:
            result = await session.execute(
                select(Doctor).where(Doctor.id == doctor_id)
            )
            doctor = result.scalar_one()

            result = await session.execute(
                select(Department).where(Department.id == doctor.department_id)
            )
            department = result.scalar_one()

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞—Ç—ã –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏ –≤–ø–µ—Ä–µ–¥
        keyboard = []
        today = datetime.now().date()

        for i in range(1, 31):  # 30 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥
            appointment_date = today + timedelta(days=i)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –≤—Ä–∞—á –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
            day_of_week = appointment_date.weekday()  # 0-–ø–Ω, 6-–≤—Å

            async with db.get_session() as session:
                result = await session.execute(
                    select(DoctorSchedule)
                    .where(DoctorSchedule.doctor_id == doctor_id)
                    .where(DoctorSchedule.day_of_week == day_of_week)
                    .where(DoctorSchedule.is_working == True)
                )
                schedule = result.scalar_one_or_none()

            if schedule:
                button_text = appointment_date.strftime("%d.%m.%Y (%a)")
                keyboard.append([
                    InlineKeyboardButton(
                        button_text,
                        callback_data=f"date_{appointment_date.strftime('%Y-%m-%d')}"
                    )
                ])

        if not keyboard:
            await query.edit_message_text(
                f"–£ –≤—Ä–∞—á–∞ {doctor.full_name} –Ω–µ—Ç —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –≤ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–≥–æ –≤—Ä–∞—á–∞."
            )
            return SELECT_DOCTOR

        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_doctors")])
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            f"üë®‚Äç‚öïÔ∏è –í—Ä–∞—á: {doctor.full_name}\n"
            f"üè• –û—Ç–¥–µ–ª–µ–Ω–∏–µ: {department.name}\n"
            f"üìã –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: {doctor.specialization}\n\n"
            "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏–µ–º–∞:",
            reply_markup=reply_markup
        )

        return SELECT_DATE

    async def select_date(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–í—ã–±–æ—Ä –¥–∞—Ç—ã"""
        query = update.callback_query
        await query.answer()

        if query.data == "back_to_doctors":
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≤—ã–±–æ—Ä—É –≤—Ä–∞—á–∞
            department_id = context.user_data.get("department_id")

            async with db.get_session() as session:
                result = await session.execute(
                    select(Doctor)
                    .where(Doctor.department_id == department_id)
                    .where(Doctor.is_active == True)
                )
                doctors = result.scalars().all()

            keyboard = []
            for doctor in doctors:
                button_text = f"üë®‚Äç‚öïÔ∏è {doctor.full_name}"
                if len(button_text) > 64:
                    button_text = button_text[:61] + "..."

                keyboard.append([
                    InlineKeyboardButton(
                        button_text,
                        callback_data=f"doc_{doctor.id}"
                    )
                ])

            keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_dept")])
            reply_markup = InlineKeyboardMarkup(keyboard)

            await query.edit_message_text(
                "üë®‚Äç‚öïÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞:",
                reply_markup=reply_markup
            )
            return SELECT_DOCTOR

        selected_date = query.data.split("_")[1]
        context.user_data["appointment_date"] = selected_date

        # –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è
        doctor_id = context.user_data["doctor_id"]
        appointment_date = datetime.strptime(selected_date, "%Y-%m-%d").date()
        day_of_week = appointment_date.weekday()

        async with db.get_session() as session:
            # –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Ä–∞—á–∞
            result = await session.execute(
                select(DoctorSchedule)
                .where(DoctorSchedule.doctor_id == doctor_id)
                .where(DoctorSchedule.day_of_week == day_of_week)
            )
            schedule = result.scalar_one()

            # –ü–æ–ª—É—á–∞–µ–º —É–∂–µ –∑–∞–Ω—è—Ç–æ–µ –≤—Ä–µ–º—è
            result = await session.execute(
                select(Appointment.appointment_time)
                .where(Appointment.doctor_id == doctor_id)
                .where(Appointment.appointment_date == appointment_date)
                .where(Appointment.status.in_(["pending", "confirmed"]))
            )
            booked_times = [t[0] for t in result.all()]

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏
        available_times = self._generate_time_slots(
            schedule.start_time,
            schedule.end_time,
            schedule.break_start,
            schedule.break_end,
            schedule.appointment_duration,
            booked_times
        )

        if not available_times:
            await query.edit_message_text(
                "–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É."
            )
            return SELECT_DATE

        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
        keyboard = []
        row = []
        for i, time_slot in enumerate(available_times):
            row.append(InlineKeyboardButton(
                time_slot.strftime("%H:%M"),
                callback_data=f"time_{time_slot.strftime('%H:%M')}"
            ))
            if len(row) == 3 or i == len(available_times) - 1:
                keyboard.append(row)
                row = []

        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_dates")])
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            "‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞:",
            reply_markup=reply_markup
        )

        return SELECT_TIME

    def _generate_time_slots(self, start_time: time, end_time: time,
                             break_start: Optional[time], break_end: Optional[time],
                             duration_minutes: int, booked_times: List[time]) -> List[time]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏"""
        slots = []
        current = datetime.combine(date.today(), start_time)
        end = datetime.combine(date.today(), end_time)

        if break_start and break_end:
            break_start_dt = datetime.combine(date.today(), break_start)
            break_end_dt = datetime.combine(date.today(), break_end)

        while current + timedelta(minutes=duration_minutes) <= end:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ —Å–ª–æ—Ç –Ω–∞ –ø–µ—Ä–µ—Ä—ã–≤
            is_break = False
            if break_start and break_end:
                slot_end = current + timedelta(minutes=duration_minutes)
                if current < break_end_dt and slot_end > break_start_dt:
                    is_break = True

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç–æ –ª–∏ –≤—Ä–µ–º—è
            is_booked = current.time() in booked_times

            if not is_break and not is_booked:
                slots.append(current.time())

            current += timedelta(minutes=duration_minutes)

        return slots

    async def select_time(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏"""
        query = update.callback_query
        await query.answer()

        if query.data == "back_to_dates":
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≤—ã–±–æ—Ä—É –¥–∞—Ç—ã
            doctor_id = context.user_data["doctor_id"]

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞—Ç—ã –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏ –≤–ø–µ—Ä–µ–¥
            keyboard = []
            today = datetime.now().date()

            for i in range(1, 31):
                appointment_date = today + timedelta(days=i)
                day_of_week = appointment_date.weekday()

                async with db.get_session() as session:
                    result = await session.execute(
                        select(DoctorSchedule)
                        .where(DoctorSchedule.doctor_id == doctor_id)
                        .where(DoctorSchedule.day_of_week == day_of_week)
                        .where(DoctorSchedule.is_working == True)
                    )
                    schedule = result.scalar_one_or_none()

                if schedule:
                    button_text = appointment_date.strftime("%d.%m.%Y (%a)")
                    keyboard.append([
                        InlineKeyboardButton(
                            button_text,
                            callback_data=f"date_{appointment_date.strftime('%Y-%m-%d')}"
                        )
                    ])

            keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_doctors")])
            reply_markup = InlineKeyboardMarkup(keyboard)

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–∞—á–µ
            async with db.get_session() as session:
                result = await session.execute(
                    select(Doctor).where(Doctor.id == doctor_id)
                )
                doctor = result.scalar_one()

                result = await session.execute(
                    select(Department).where(Department.id == doctor.department_id)
                )
                department = result.scalar_one()

            await query.edit_message_text(
                f"üë®‚Äç‚öïÔ∏è –í—Ä–∞—á: {doctor.full_name}\n"
                f"üè• –û—Ç–¥–µ–ª–µ–Ω–∏–µ: {department.name}\n\n"
                "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏–µ–º–∞:",
                reply_markup=reply_markup
            )
            return SELECT_DATE

        selected_time = query.data.split("_")[1]
        context.user_data["appointment_time"] = selected_time

        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞
        await query.edit_message_text(
            "üë§ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û (–ø–æ–ª–Ω–æ—Å—Ç—å—é):\n\n"
            "–ü—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á\n\n"
            "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–æ–¥–∏—Ç–µ —Å–≤–æ–∏ –Ω–∞—Å—Ç–æ—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ, "
            "–æ–Ω–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∫–∞—Ä—Ç—ã."
        )

        return ENTER_NAME

    async def enter_name(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–í–≤–æ–¥ –§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞"""
        name = update.message.text.strip()

        # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if len(name) < 5 or len(name.split()) < 2:
            await update.message.reply_text(
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é (–º–∏–Ω–∏–º—É–º 2 —Å–ª–æ–≤–∞, –Ω–µ –º–µ–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤).\n"
                "–ü—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
            )
            return ENTER_NAME

        context.user_data["patient_name"] = name

        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
        keyboard = [
            [KeyboardButton("üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞", request_contact=True)]
        ]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)

        await update.message.reply_text(
            "üì± –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:\n\n"
            "–ü—Ä–∏–º–µ—Ä: +79161234567",
            reply_markup=reply_markup
        )

        return ENTER_PHONE

    async def enter_phone(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–í–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
        phone = None

        if update.message.contact:
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–µ–ª–∏–ª—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
            phone = update.message.contact.phone_number
        else:
            # –ï—Å–ª–∏ –≤–≤–µ–ª –≤—Ä—É—á–Ω—É—é
            phone = update.message.text.strip()

        # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if not self._validate_phone(phone):
            await update.message.reply_text(
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n"
                "–ü—Ä–∏–º–µ—Ä: +79161234567 –∏–ª–∏ 89161234567"
            )
            return ENTER_PHONE

        context.user_data["patient_phone"] = phone

        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è
        keyboard = [
            [KeyboardButton("–°–µ–≥–æ–¥–Ω—è")],
            [KeyboardButton("–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å")]
        ]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)

        await update.message.reply_text(
            "üìÖ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–¥–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∫–∞—Ä—Ç—ã):\n\n"
            "–§–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì\n"
            "–ü—Ä–∏–º–µ—Ä: 15.05.1990\n\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:",
            reply_markup=reply_markup
        )

        return ENTER_BIRTHDATE

    async def enter_birthdate(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–í–≤–æ–¥ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è"""
        birthdate_input = update.message.text.strip()
        birthdate = None

        if birthdate_input == "–°–µ–≥–æ–¥–Ω—è":
            birthdate = datetime.now().date()
        elif birthdate_input == "–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å":
            birthdate = None
        else:
            try:
                birthdate = datetime.strptime(birthdate_input, "%d.%m.%Y").date()

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –≤ –±—É–¥—É—â–µ–º
                if birthdate > datetime.now().date():
                    await update.message.reply_text(
                        "‚ùå –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º. "
                        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–∞—Ç—É."
                    )
                    return ENTER_BIRTHDATE

            except ValueError:
                await update.message.reply_text(
                    "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì\n"
                    "–ü—Ä–∏–º–µ—Ä: 15.05.1990"
                )
                return ENTER_BIRTHDATE

        if birthdate:
            context.user_data["patient_birthdate"] = birthdate.isoformat()

        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–∏–º–ø—Ç–æ–º—ã/–∂–∞–ª–æ–±—ã
        keyboard = [
            [KeyboardButton("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å")],
            [KeyboardButton("–ù–µ –∑–Ω–∞—é")]
        ]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)

        await update.message.reply_text(
            "üìù –û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Å–∏–º–ø—Ç–æ–º—ã –∏–ª–∏ –∂–∞–ª–æ–±—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):\n\n"
            "–≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–º–æ–∂–µ—Ç –≤—Ä–∞—á—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –ø—Ä–∏–µ–º—É.\n"
            "–ü—Ä–∏–º–µ—Ä: '–ë–æ–ª–∏—Ç –≥–æ—Ä–ª–æ, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 37.5, –∫–∞—à–µ–ª—å'",
            reply_markup=reply_markup,
            reply_to_message_id=update.message.message_id
        )

        return ENTER_SYMPTOMS

    async def enter_symptoms(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–í–≤–æ–¥ —Å–∏–º–ø—Ç–æ–º–æ–≤"""
        symptoms = update.message.text.strip()

        if symptoms in ["–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", "–ù–µ –∑–Ω–∞—é", "–ù–µ—Ç", "–ù–µ —É–∫–∞–∑–∞–Ω–æ"]:
            symptoms = None

        if symptoms:
            context.user_data["symptoms"] = symptoms

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        doctor_id = context.user_data["doctor_id"]
        appointment_date = context.user_data["appointment_date"]
        appointment_time = context.user_data["appointment_time"]

        async with db.get_session() as session:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–∞—á–µ
            result = await session.execute(
                select(Doctor).where(Doctor.id == doctor_id)
            )
            doctor = result.scalar_one()

            result = await session.execute(
                select(Department).where(Department.id == doctor.department_id)
            )
            department = result.scalar_one()

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
        date_str = datetime.strptime(appointment_date, "%Y-%m-%d").strftime("%d.%m.%Y")
        time_str = appointment_time

        confirm_text = f"""
‚úÖ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–ø–∏—Å—å:

üë®‚Äç‚öïÔ∏è –í—Ä–∞—á: {doctor.full_name}
üè• –û—Ç–¥–µ–ª–µ–Ω–∏–µ: {department.name}
üìÖ –î–∞—Ç–∞: {date_str}
‚è∞ –í—Ä–µ–º—è: {time_str}
üë§ –ü–∞—Ü–∏–µ–Ω—Ç: {context.user_data['patient_name']}
üì± –¢–µ–ª–µ—Ñ–æ–Ω: {context.user_data['patient_phone']}
"""

        if "patient_birthdate" in context.user_data:
            birthdate_str = datetime.strptime(
                context.user_data["patient_birthdate"], "%Y-%m-%d"
            ).strftime("%d.%m.%Y")
            confirm_text += f"üéÇ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {birthdate_str}\n"

        if "symptoms" in context.user_data:
            symptoms_text = context.user_data["symptoms"][:100] + "..." \
                if len(context.user_data["symptoms"]) > 100 else context.user_data["symptoms"]
            confirm_text += f"üìù –°–∏–º–ø—Ç–æ–º—ã: {symptoms_text}\n"

        confirm_text += "\n‚ö†Ô∏è –ó–∞–ø–∏—Å—å –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 24 —á–∞—Å–∞ –¥–æ –ø—Ä–∏–µ–º–∞.\n"
        confirm_text += "\n–í—Å—ë –≤–µ—Ä–Ω–æ?"

        keyboard = [
            [
                InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data="confirm_yes"),
                InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="confirm_no")
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            confirm_text,
            reply_markup=reply_markup,
            reply_to_message_id=update.message.message_id
        )

        return CONFIRM

    async def confirm_appointment(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏"""
        query = update.callback_query
        await query.answer()

        if query.data == "confirm_no":
            await query.edit_message_text(
                "‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞.\n\n"
                "–ï—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ, –Ω–∞–∂–º–∏—Ç–µ /record –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏."
            )
            return ConversationHandler.END

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î
        try:
            async with db.get_session() as session:
                # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
                appointment = Appointment(
                    user_id=update.effective_user.id,
                    doctor_id=context.user_data["doctor_id"],
                    appointment_date=datetime.strptime(
                        context.user_data["appointment_date"], "%Y-%m-%d"
                    ).date(),
                    appointment_time=datetime.strptime(
                        context.user_data["appointment_time"], "%H:%M"
                    ).time(),
                    patient_name=context.user_data["patient_name"],
                    patient_phone=context.user_data["patient_phone"],
                    patient_birthdate=datetime.strptime(
                        context.user_data.get("patient_birthdate", "2000-01-01"), "%Y-%m-%d"
                    ).date() if "patient_birthdate" in context.user_data else None,
                    symptoms=context.user_data.get("symptoms"),
                    status="confirmed"
                )

                session.add(appointment)
                await session.flush()  # –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–ø–∏—Å–∏

                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–∞—á–µ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
                result = await session.execute(
                    select(Doctor).where(Doctor.id == context.user_data["doctor_id"])
                )
                doctor = result.scalar_one()

                result = await session.execute(
                    select(Department).where(Department.id == doctor.department_id)
                )
                department = result.scalar_one()

                await session.commit()

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            date_str = datetime.strptime(
                context.user_data["appointment_date"], "%Y-%m-%d"
            ).strftime("%d.%m.%Y")

            success_text = f"""
üéâ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!

üìã –ù–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏: #{appointment.id}
üë®‚Äç‚öïÔ∏è –í—Ä–∞—á: {doctor.full_name}
üè• –û—Ç–¥–µ–ª–µ–Ω–∏–µ: {department.name} (–∫–∞–±. {department.room})
üìÖ –î–∞—Ç–∞: {date_str}
‚è∞ –í—Ä–µ–º—è: {context.user_data['appointment_time']}
üë§ –ü–∞—Ü–∏–µ–Ω—Ç: {context.user_data['patient_name']}

üìå –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞ 10-15 –º–∏–Ω—É—Ç –¥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
2. –í–æ–∑—å–º–∏—Ç–µ —Å —Å–æ–±–æ–π –ø–∞—Å–ø–æ—Ä—Ç –∏ —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å
3. –ó–∞–ø–∏—Å—å –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥–æ–π /cancel_record

üìç –ê–¥—Ä–µ—Å: —É–ª. –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è, –¥. 15
üöá –ú–µ—Ç—Ä–æ: "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è" (–≤—ã—Ö–æ–¥ ‚Ññ3)

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ!
            """

            # –ü–ª–∞–Ω–∏—Ä—É–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
            appointment_datetime = datetime.combine(
                appointment.appointment_date,
                appointment.appointment_time
            )

            # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å
            reminder_time = appointment_datetime - timedelta(days=1)
            if reminder_time > datetime.now():
                context.job_queue.run_once(
                    self.send_reminder,
                    when=reminder_time,
                    data=update.effective_user.id,
                    name=f"reminder_{appointment.id}"
                )

            # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 2 —á–∞—Å–∞
            reminder_2h = appointment_datetime - timedelta(hours=2)
            if reminder_2h > datetime.now():
                context.job_queue.run_once(
                    self.send_reminder_2h,
                    when=reminder_2h,
                    data=update.effective_user.id,
                    name=f"reminder_2h_{appointment.id}"
                )

            await query.edit_message_text(success_text)

        except Exception as e:
            logger.error(f"Error creating appointment: {e}")
            await query.edit_message_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É."
            )

        return ConversationHandler.END

    async def send_reminder(self, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ –¥–µ–Ω—å"""
        user_id = context.job.data
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text="üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ó–∞–≤—Ç—Ä–∞ —É –≤–∞—Å –∑–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É! "
                     "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–∑—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã."
            )
        except Exception as e:
            logger.error(f"Error sending reminder: {e}")

    async def send_reminder_2h(self, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ 2 —á–∞—Å–∞"""
        user_id = context.job.data
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text="‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞ —É –≤–∞—Å –∑–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É!"
            )
        except Exception as e:
            logger.error(f"Error sending 2h reminder: {e}")

    async def my_records(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π"""
        user_id = update.effective_user.id

        try:
            async with db.get_session() as session:
                result = await session.execute(
                    select(Appointment, Doctor, Department)
                    .join(Doctor, Appointment.doctor_id == Doctor.id)
                    .join(Department, Doctor.department_id == Department.id)
                    .where(Appointment.user_id == user_id)
                    .where(Appointment.status.in_(["pending", "confirmed"]))
                    .order_by(Appointment.appointment_date, Appointment.appointment_time)
                )
                records = result.all()

            if not records:
                await update.message.reply_text(
                    "üì≠ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.\n\n"
                    "–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞–∂–º–∏—Ç–µ /record"
                )
                return

            text = "üìã –í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏:\n\n"

            for appointment, doctor, department in records:
                date_str = appointment.appointment_date.strftime("%d.%m.%Y")
                time_str = appointment.appointment_time.strftime("%H:%M")

                text += f"""
üìã –ó–∞–ø–∏—Å—å ‚Ññ{appointment.id}
üë®‚Äç‚öïÔ∏è –í—Ä–∞—á: {doctor.full_name}
üè• –û—Ç–¥–µ–ª–µ–Ω–∏–µ: {department.name}
üìÖ –î–∞—Ç–∞: {date_str}
‚è∞ –í—Ä–µ–º—è: {time_str}
üë§ –ü–∞—Ü–∏–µ–Ω—Ç: {appointment.patient_name}
üìû –¢–µ–ª–µ—Ñ–æ–Ω: {appointment.patient_phone}
üîÑ –°—Ç–∞—Ç—É—Å: {appointment.status}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
"""

            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å—è–º–∏
            keyboard = [
                [
                    InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å", callback_data="cancel_record_menu"),
                    InlineKeyboardButton("üìÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å", callback_data="new_record")
                ]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await update.message.reply_text(text, reply_markup=reply_markup)

        except Exception as e:
            logger.error(f"Error fetching records: {e}")
            await update.message.reply_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )

    async def show_departments(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–¥–µ–ª–µ–Ω–∏—è"""
        try:
            async with db.get_session() as session:
                result = await session.execute(
                    select(Department)
                    .where(Department.is_active == True)
                    .order_by(Department.name)
                )
                departments = result.scalars().all()

            if not departments:
                await update.message.reply_text(
                    "üè• –í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ—Ç–¥–µ–ª–µ–Ω–∏–π."
                )
                return

            text = "üè• –û—Ç–¥–µ–ª–µ–Ω–∏—è –Ω–∞—à–µ–π –±–æ–ª—å–Ω–∏—Ü—ã:\n\n"

            for dept in departments:
                text += f"‚Ä¢ {dept.name}"
                if dept.description:
                    text += f" - {dept.description}"
                if dept.floor:
                    text += f" ({dept.floor} —ç—Ç–∞–∂, –∫–∞–±. {dept.room})"
                text += "\n"

            keyboard = [
                [InlineKeyboardButton("üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏ –æ—Ç–¥–µ–ª–µ–Ω–∏—è", callback_data="show_doctors_list")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await update.message.reply_text(text, reply_markup=reply_markup)

        except Exception as e:
            logger.error(f"Error showing departments: {e}")
            await update.message.reply_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –æ—Ç–¥–µ–ª–µ–Ω–∏–π."
            )

    async def show_doctors(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –≤—Ä–∞—á–µ–π"""
        try:
            async with db.get_session() as session:
                result = await session.execute(
                    select(Doctor, Department)
                    .join(Department, Doctor.department_id == Department.id)
                    .where(Doctor.is_active == True)
                    .order_by(Department.name, Doctor.full_name)
                )
                doctors = result.all()

            if not doctors:
                await update.message.reply_text("üë®‚Äç‚öïÔ∏è –í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤—Ä–∞—á–µ–π.")
                return

            text = "üë®‚Äç‚öïÔ∏è –ù–∞—à–∏ –≤—Ä–∞—á–∏:\n\n"

            current_dept = None
            for doctor, department in doctors:
                if current_dept != department.name:
                    text += f"\nüè• {department.name}:\n"
                    current_dept = department.name

                text += f"‚Ä¢ {doctor.full_name} - {doctor.specialization}"
                if doctor.qualification:
                    text += f" ({doctor.qualification})"
                if doctor.experience:
                    text += f", –æ–ø—ã—Ç {doctor.experience} –ª–µ—Ç"
                text += "\n"

            keyboard = [
                [InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º", callback_data="start_record_from_doctors")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await update.message.reply_text(text, reply_markup=reply_markup)

        except Exception as e:
            logger.error(f"Error showing doctors: {e}")
            await update.message.reply_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π."
            )

    async def cancel_record(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏"""
        user_id = update.effective_user.id

        try:
            async with db.get_session() as session:
                # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                result = await session.execute(
                    select(Appointment, Doctor)
                    .join(Doctor, Appointment.doctor_id == Doctor.id)
                    .where(Appointment.user_id == user_id)
                    .where(Appointment.status.in_(["pending", "confirmed"]))
                    .where(Appointment.appointment_date >= datetime.now().date())
                    .order_by(Appointment.appointment_date)
                )
                appointments = result.all()

            if not appointments:
                await update.message.reply_text(
                    "üì≠ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–º–µ–Ω—ã."
                )
                return

            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∑–∞–ø–∏—Å—è–º–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã
            keyboard = []
            for appointment, doctor in appointments:
                date_str = appointment.appointment_date.strftime("%d.%m.%Y")
                time_str = appointment.appointment_time.strftime("%H:%M")

                button_text = f"‚ùå {date_str} {time_str} - {doctor.full_name}"
                if len(button_text) > 64:
                    button_text = button_text[:61] + "..."

                keyboard.append([
                    InlineKeyboardButton(
                        button_text,
                        callback_data=f"cancel_{appointment.id}"
                    )
                ])

            reply_markup = InlineKeyboardMarkup(keyboard)

            await update.message.reply_text(
                "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è –æ—Ç–º–µ–Ω—ã:",
                reply_markup=reply_markup
            )

        except Exception as e:
            logger.error(f"Error in cancel_record: {e}")
            await update.message.reply_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )

    async def process_cancel(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏"""
        query = update.callback_query
        await query.answer()

        appointment_id = int(query.data.split("_")[1])

        try:
            async with db.get_session() as session:
                # –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å—å
                result = await session.execute(
                    select(Appointment)
                    .where(Appointment.id == appointment_id)
                    .where(Appointment.user_id == query.from_user.id)
                )
                appointment = result.scalar_one_or_none()

                if not appointment:
                    await query.edit_message_text(
                        "‚ùå –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –µ–µ –æ—Ç–º–µ–Ω—ã."
                    )
                    return

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å (–Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 24 —á–∞—Å–∞)
                appointment_datetime = datetime.combine(
                    appointment.appointment_date,
                    appointment.appointment_time
                )

                if datetime.now() + timedelta(hours=24) > appointment_datetime:
                    await query.edit_message_text(
                        "‚ùå –ó–∞–ø–∏—Å—å –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 24 —á–∞—Å–∞ –¥–æ –ø—Ä–∏–µ–º–∞.\n\n"
                        "–î–ª—è –æ—Ç–º–µ–Ω—ã —Å—Ä–æ—á–Ω–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É: +7 (XXX) XXX-XX-XX"
                    )
                    return

                # –û—Ç–º–µ–Ω—è–µ–º –∑–∞–ø–∏—Å—å
                appointment.status = "cancelled"
                await session.commit()

                # –£–¥–∞–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                job_name_reminder = f"reminder_{appointment.id}"
                job_name_reminder_2h = f"reminder_2h_{appointment.id}"

                if job_name_reminder in context.job_queue.jobs():
                    context.job_queue.jobs()[job_name_reminder].schedule_removal()
                if job_name_reminder_2h in context.job_queue.jobs():
                    context.job_queue.jobs()[job_name_reminder_2h].schedule_removal()

                await query.edit_message_text(
                    "‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞.\n\n"
                    "–ù–∞–¥–µ–µ–º—Å—è –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞!"
                )

        except Exception as e:
            logger.error(f"Error cancelling appointment: {e}")
            await query.edit_message_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É."
            )

    async def admin_panel(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
        user_id = update.effective_user.id

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        if user_id != config.ADMIN_ID:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
            return

        keyboard = [
            [
                InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats"),
                InlineKeyboardButton("üìã –ó–∞–ø–∏—Å–∏", callback_data="admin_appointments")
            ],
            [
                InlineKeyboardButton("üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏", callback_data="admin_doctors"),
                InlineKeyboardButton("üè• –û—Ç–¥–µ–ª–µ–Ω–∏—è", callback_data="admin_departments")
            ],
            [
                InlineKeyboardButton("üìà –û—Ç—á–µ—Ç—ã", callback_data="admin_reports"),
                InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="admin_settings")
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            "üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:",
            reply_markup=reply_markup
        )

    async def cancel_conversation(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞"""
        await update.message.reply_text(
            "‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
            reply_markup=ReplyKeyboardRemove()
        )
        return ConversationHandler.END

    def _validate_phone(self, phone: str) -> bool:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
        import re

        # –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ +
        cleaned = re.sub(r'[^\d+]', '', phone)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã
        patterns = [
            r'^\+7\d{10}$',  # +79161234567
            r'^8\d{10}$',  # 89161234567
            r'^7\d{10}$',  # 79161234567
            r'^\d{10}$',  # 9161234567
        ]

        return any(re.match(pattern, cleaned) for pattern in patterns)

    async def init_bot(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞"""
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        await db.init()

        # –°–æ–∑–¥–∞–µ–º Application
        self.app = Application.builder().token(config.BOT_TOKEN).build()

        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

        # ConversationHandler –¥–ª—è –∑–∞–ø–∏—Å–∏
        conv_handler = ConversationHandler(
            entry_points=[
                CommandHandler("record", self.start_record),
                MessageHandler(filters.Regex("^(üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º)$"), self.start_record),
                CallbackQueryHandler(self.start_record, pattern="^start_record_from_doctors$")
            ],
            states={
                SELECT_DEPARTMENT: [CallbackQueryHandler(self.select_department)],
                SELECT_DOCTOR: [CallbackQueryHandler(self.select_doctor)],
                SELECT_DATE: [CallbackQueryHandler(self.select_date)],
                SELECT_TIME: [CallbackQueryHandler(self.select_time)],
                ENTER_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.enter_name)],
                ENTER_PHONE: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, self.enter_phone),
                    MessageHandler(filters.CONTACT, self.enter_phone)
                ],
                ENTER_BIRTHDATE: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.enter_birthdate)],
                ENTER_SYMPTOMS: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.enter_symptoms)],
                CONFIRM: [CallbackQueryHandler(self.confirm_appointment)]
            },
            fallbacks=[
                CommandHandler("cancel", self.cancel_conversation),
                MessageHandler(filters.Regex("^(–û—Ç–º–µ–Ω–∞|‚ùå –û—Ç–º–µ–Ω–∞)$"), self.cancel_conversation)
            ]
        )

        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
        self.app.add_handler(CommandHandler("start", self.start))
        self.app.add_handler(conv_handler)
        self.app.add_handler(CommandHandler("my_records", self.my_records))
        self.app.add_handler(CommandHandler("cancel_record", self.cancel_record))
        self.app.add_handler(CommandHandler("admin", self.admin_panel))

        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        self.app.add_handler(MessageHandler(filters.Regex("^(üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏)$"), self.my_records))
        self.app.add_handler(MessageHandler(filters.Regex("^(üè• –û—Ç–¥–µ–ª–µ–Ω–∏—è)$"), self.show_departments))
        self.app.add_handler(MessageHandler(filters.Regex("^(üë®‚Äç‚öïÔ∏è –ù–∞—à–∏ –≤—Ä–∞—á–∏)$"), self.show_doctors))

        # CallbackQuery –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        self.app.add_handler(CallbackQueryHandler(self.show_doctors, pattern="^show_doctors_list$"))
        self.app.add_handler(CallbackQueryHandler(self.process_cancel, pattern="^cancel_"))

        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–º)
        self.app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))

        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        self.app.add_error_handler(self.error_handler)

        logger.info("–ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ")

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        text = update.message.text

        if text == "–û—Ç–º–µ–Ω–∞" or text == "‚ùå –û—Ç–º–µ–Ω–∞":
            await self.cancel_conversation(update, context)
        else:
            await update.message.reply_text(
                "–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥."
            )

    async def error_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"""
        logger.error(f"Exception while handling an update: {context.error}")

        if update and update.effective_message:
            await update.effective_message.reply_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É."
            )

    async def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        if not self.app:
            await self.init_bot()

        logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        await self.app.run_polling(allowed_updates=Update.ALL_UPDATES)

    async def shutdown(self):
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"""
        await db.close()
        logger.info("–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")


# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async def main():
    bot = HospitalBot()
    try:
        await bot.run()
    except (KeyboardInterrupt, SystemExit):
        logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã...")
    finally:
        await bot.shutdown()


if __name__ == "__main__":
    asyncio.run(main())
